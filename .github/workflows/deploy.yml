name: Deploy Website

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

# Prevent multiple concurrent runs - cancels older runs when new one starts
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Auto-cancel if workflow runs longer than 15 minutes
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (if needed for build tools)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Create environment config file with secrets
      # This file will be deployed to GitHub Pages
      - name: Create environment config
        run: |
          cat > env-config.js << EOF
          // This file is generated during deployment
          // DO NOT commit secrets directly to the repository
          window.ENV_CONFIG = {
            emailjsUserId: '${{ secrets.EMAILJS_USER_ID }}',
            emailjsServiceId: '${{ secrets.EMAILJS_SERVICE_ID }}',
            emailjsTemplateId: '${{ secrets.EMAILJS_TEMPLATE_ID }}',
            jsonbinAccessKey: '${{ secrets.JSONBIN_ACCESS_KEY }}',
            jsonbinBinId: '${{ secrets.JSONBIN_BIN_ID }}'
          };
          EOF
          # Verify file was created and contains content
          ls -la env-config.js
          echo "File size: $(wc -c < env-config.js) bytes"
          echo "✅ env-config.js created successfully"
        # Note: Secrets are automatically available via ${{ secrets.SECRET_NAME }}
        # They are masked in logs for security

      # Inject secrets into newsletter.js (if using placeholders)
      # Uncomment this step if you've updated newsletter.js to use placeholders
      - name: Inject secrets into newsletter.js
        if: false # Set to true if you want to enable secret injection
        env:
          EMAILJS_USER_ID: ${{ secrets.EMAILJS_USER_ID }}
          EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
          EMAILJS_TEMPLATE_ID: ${{ secrets.EMAILJS_TEMPLATE_ID }}
          JSONBIN_ACCESS_KEY: ${{ secrets.JSONBIN_ACCESS_KEY }}
          JSONBIN_BIN_ID: ${{ secrets.JSONBIN_BIN_ID }}
        run: |
          # Make script executable
          chmod +x scripts/inject-secrets.sh
          # Run injection script
          ./scripts/inject-secrets.sh

          # Alternative: Direct sed replacement (uncomment if not using script)
          # sed -i "s|{{EMAILJS_USER_ID}}|${{ secrets.EMAILJS_USER_ID }}|g" newsletter.js
          # sed -i "s|{{EMAILJS_SERVICE_ID}}|${{ secrets.EMAILJS_SERVICE_ID }}|g" newsletter.js
          # sed -i "s|{{EMAILJS_TEMPLATE_ID}}|${{ secrets.EMAILJS_TEMPLATE_ID }}|g" newsletter.js
          # sed -i "s|{{JSONBIN_ACCESS_KEY}}|${{ secrets.JSONBIN_ACCESS_KEY }}|g" newsletter.js
          # sed -i "s|{{JSONBIN_BIN_ID}}|${{ secrets.JSONBIN_BIN_ID }}|g" newsletter.js

      # Example: Use GitHub API with secrets to update files
      - name: Update subscribers file via GitHub API
        if: false # Set to true if you want to enable this
        run: |
          # This example shows how to use secrets with GitHub API
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"message":"Update subscribers","content":"'$(base64 -w 0 data/subscribers.json)'","sha":"'$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/contents/data/subscribers.json | jq -r .sha)'"}' \
            https://api.github.com/repos/${{ github.repository }}/contents/data/subscribers.json

      # Ensure env-config.js is included in deployment
      # The file is in .gitignore to prevent committing to main branch,
      # but we need it deployed to gh-pages
      # The peaceiris/actions-gh-pages action copies from filesystem, so we need to
      # ensure .gitignore doesn't exclude it when copying
      - name: Prepare env-config.js for deployment
        run: |
          if [ -f "env-config.js" ]; then
            echo "✅ env-config.js exists"
            # Completely remove env-config.js from .gitignore
            # Use multiple methods to ensure it's removed
            grep -v "^env-config\.js$" .gitignore > .gitignore.tmp && mv .gitignore.tmp .gitignore || true
            # Also try sed as backup
            sed -i.bak '/^env-config\.js$/d' .gitignore || true
            rm -f .gitignore.bak || true
            # Verify it's removed
            if grep -q "^env-config\.js$" .gitignore 2>/dev/null; then
              echo "⚠️ WARNING: Still in .gitignore, trying again..."
              grep -v "^env-config\.js$" .gitignore > .gitignore.new && mv .gitignore.new .gitignore
            fi
            echo "Temporarily removed env-config.js from .gitignore for deployment"
            # Verify the file exists and has content
            ls -la env-config.js
            echo "File size: $(wc -c < env-config.js) bytes"
            # Verify .gitignore doesn't contain it
            echo "Checking .gitignore:"
            grep "env-config" .gitignore || echo "✅ env-config.js not in .gitignore"
            echo "File will be deployed to gh-pages"
          else
            echo "❌ ERROR: env-config.js not found!"
            exit 1
          fi

      # Final verification before deployment
      - name: Verify env-config.js will be deployed
        run: |
          echo "Final check before deployment:"
          ls -la env-config.js
          echo "File contents (first 3 lines):"
          head -3 env-config.js
          echo "Checking if file is in .gitignore:"
          if grep -q "^env-config\.js$" .gitignore 2>/dev/null; then
            echo "❌ ERROR: env-config.js is still in .gitignore!"
            cat .gitignore | grep env-config || echo "Not found in .gitignore"
            exit 1
          else
            echo "✅ env-config.js is NOT in .gitignore - will be deployed"
          fi
          echo "Files that will be deployed (sample):"
          ls -1 | head -20
          # Explicitly verify env-config.js is in the list
          if ls -1 | grep -q "^env-config\.js$"; then
            echo "✅ env-config.js is in the file list - will be copied"
          else
            echo "❌ ERROR: env-config.js NOT in file list!"
            exit 1
          fi
          # Force add to git to ensure it's tracked (even though action copies from filesystem)
          # This helps ensure git doesn't exclude it during add --all
          git add -f env-config.js 2>/dev/null || echo "Note: git add -f (file will be copied by action)"

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          cname: true
          keep_files: false
          force_orphan: false
          allow_empty_commit: true
          exclude_assets: ""

      # Verify env-config.js was deployed
      - name: Verify env-config.js deployment
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Checking if env-config.js was deployed..."
          sleep 5  # Wait for GitHub Pages to update
          # Check the gh-pages branch
          git fetch origin gh-pages:gh-pages || true
          git checkout gh-pages || true
          if [ -f "env-config.js" ]; then
            echo "✅ SUCCESS: env-config.js is in gh-pages branch"
            ls -la env-config.js
          else
            echo "❌ ERROR: env-config.js NOT found in gh-pages branch!"
            echo "Files in gh-pages:"
            ls -1 | head -20
            exit 1
          fi
          git checkout main || true

      # Example: Deploy to other hosting services
      - name: Deploy to custom server (example)
        if: false # Set to true and configure if needed
        run: |
          # Example: Use secrets for FTP/SSH deployment
          # lftp -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} -e "mirror -R ./ /public_html/; quit" ${{ secrets.FTP_HOST }}
          echo "Configure your deployment command here"

      # Example: Send notification using secrets
      - name: Send deployment notification
        if: false # Set to true if you want notifications
        run: |
          # Example: Send email notification using EmailJS API
          curl -X POST https://api.emailjs.com/api/v1.0/email/send \
            -H "Content-Type: application/json" \
            -d '{
              "service_id": "${{ secrets.EMAILJS_SERVICE_ID }}",
              "template_id": "${{ secrets.EMAILJS_TEMPLATE_ID }}",
              "user_id": "${{ secrets.EMAILJS_USER_ID }}",
              "template_params": {
                "message": "Website deployed successfully",
                "deployment_time": "'$(date)'"
              }
            }'
